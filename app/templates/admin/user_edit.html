{% extends "base.html" %}

{% block title %}Benutzer bearbeiten – {{ user_row.email }}{% endblock %}

{% block content %}
<div class="page-header">
  <div class="flex-between">
    <div>
      <h1>Benutzer bearbeiten</h1>
      <p style="color: var(--text-secondary);">{{ user_row.email }}</p>
    </div>
    <div class="btn-group">
      <a href="/admin/users" class="btn btn-outline">← Benutzer</a>
      <a href="/admin/" class="btn btn-outline">Dashboard</a>
    </div>
  </div>
</div>

<div class="card">
  <h2 class="card-title">Profil</h2>
  <form method="post" action="/admin/users/{{ user_row.id }}/edit">
    <div class="form-row">
      <div class="form-group">
        <label>E-Mail *</label>
        <input name="email" type="email" value="{{ user_row.email }}" required>
      </div>
      <div class="form-group">
        <label>Rolle</label>
        <select name="role">
          <option value="recruiter" {% if user_row.role == 'recruiter' %}selected{% endif %}>Recruiter</option>
          <option value="viewer" {% if user_row.role == 'viewer' %}selected{% endif %}>Viewer</option>
          <option value="admin" {% if user_row.role == 'admin' %}selected{% endif %}>Admin</option>
        </select>
      </div>
    </div>

    <details class="details-block" style="margin-top: 0.75rem;">
      <summary class="details-summary">Passwort zurücksetzen <span class="details-summary-meta">optional</span></summary>
      <div style="padding: 1rem 1.25rem;">
        <div class="form-row">
          <div class="form-group" style="margin-bottom:0;">
            <label>Neues Passwort</label>
            <div class="password-field">
              <input id="admin-new-password" name="new_password" type="password" minlength="8" placeholder="mind. 8 Zeichen, 1 Großbuchstabe, 1 Sonderzeichen">
              <button
                type="button"
                class="password-toggle"
                data-toggle-password="#admin-new-password"
                aria-label="Passwort anzeigen/verbergen"
                title="Passwort anzeigen/verbergen"
              >
                <svg data-eye="open" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                  <path d="M2 12s3.5-7 10-7 10 7 10 7-3.5 7-10 7S2 12 2 12z"></path>
                  <circle cx="12" cy="12" r="3"></circle>
                </svg>
                <svg data-eye="off" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true" style="display:none;">
                  <path d="M17.94 17.94A10.94 10.94 0 0 1 12 19c-6.5 0-10-7-10-7a21.8 21.8 0 0 1 5.06-6.94"></path>
                  <path d="M1 1l22 22"></path>
                  <path d="M9.9 4.24A10.94 10.94 0 0 1 12 5c6.5 0 10 7 10 7a21.8 21.8 0 0 1-3.2 4.6"></path>
                  <path d="M14.12 14.12a3 3 0 0 1-4.24-4.24"></path>
                </svg>
              </button>
            </div>
            <p class="wf-help" style="margin-top:0.4rem;">Leer lassen, wenn das Passwort unverändert bleiben soll.</p>
          </div>
        </div>
      </div>
    </details>

    <div class="wf-actions-bar" style="margin-top: 1rem;">
      <div class="wf-dirty" style="color: var(--text-secondary);">ID: {{ user_row.id }}</div>
      <div class="btn-group" style="margin:0;">
        <button type="submit" class="btn btn-primary">Speichern</button>
        <a href="/admin/users" class="btn btn-outline">Zurück</a>
      </div>
    </div>
  </form>
</div>

<div class="card">
  <h2 class="card-title">Einladung / Passwort-Link</h2>
  <p class="wf-help" style="margin-top:0.25rem;">
    Sendet eine E-Mail mit einem Link zum Passwort setzen (best-effort; erfordert M365 Konfiguration).
  </p>
  <form method="post" action="/admin/users/{{ user_row.id }}/invite" style="margin-top: 0.75rem;">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
    <button type="submit" class="btn btn-outline">{{ icon("mail") }} Einladung / Passwort-Link senden</button>
  </form>
</div>

<div class="card">
  <h2 class="card-title">Löschen (Gefahrenzone)</h2>
  <p class="wf-help" style="margin-top:0.25rem;">
    Löschen ist nur möglich, wenn Abhängigkeiten sauber behandelt werden. Du kannst optional einen Ersatz-Benutzer wählen,
    dem Zuweisungen/Owner/Benachrichtigungen übertragen werden.
  </p>

  <div class="wf-step-card" style="margin-top: 0.75rem;">
    <div class="wf-step-header" style="margin-bottom: 0;">
      <div class="wf-step-title">
        <span class="wf-pill">Abhängigkeiten</span>
        <span class="wf-step-name-preview" title="">{{ user_row.email }}</span>
      </div>
    </div>
    <div style="margin-top: 0.75rem; display:grid; gap:0.35rem; color: var(--text-secondary); font-size: 0.9rem;">
      <div>Workflow-Step Owner: <strong style="color:var(--text-primary)">{{ impact.workflow_step_owner }}</strong></div>
      <div>Workflow-Step Fallback: <strong style="color:var(--text-primary)">{{ impact.workflow_step_fallback }}</strong></div>
      <div>Assigned Step-Instanzen: <strong style="color:var(--text-primary)">{{ impact.step_instances_assigned }}</strong></div>
      <div>Doc-Updates (Audit): <strong style="color:var(--text-primary)">{{ impact.doc_status_updated }}</strong></div>
      <div>Dokument-Links (Audit): <strong style="color:var(--text-primary)">{{ impact.attachment_links }}</strong></div>
      <div>Notizen (Autor): <strong style="color:var(--text-primary)">{{ impact.notes_authored }}</strong></div>
      <div>Benachrichtigungen: <strong style="color:var(--text-primary)">{{ impact.notifications }}</strong></div>
    </div>
  </div>

  <form method="post" action="/admin/users/{{ user_row.id }}/delete" style="margin-top: 1rem;">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
    <div class="form-row">
      <div class="form-group">
        <label>Ersatz-Benutzer (optional, aber nötig bei Benachrichtigungen)</label>
        <select name="replacement_user_id">
          <option value="">— kein Ersatz —</option>
          {% for u in replacements %}
            <option value="{{ u.id }}">{{ u.email }} ({{ u.role }})</option>
          {% endfor %}
        </select>
        <p class="wf-help" style="margin-top:0.4rem;">
          Wenn ausgewählt, werden Zuweisungen/Owner/Benachrichtigungen auf diese Person übertragen.
        </p>
      </div>
    </div>
    <button type="submit" class="btn btn-danger" onclick="return confirm('Benutzer wirklich löschen? Diese Aktion kann nicht rückgängig gemacht werden.')">
      Benutzer löschen
    </button>
  </form>
</div>
{% endblock %}

